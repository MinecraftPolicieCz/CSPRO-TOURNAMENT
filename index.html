<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <title>LIGHTSMC.EU - Správa Turnajů</title>
    <link rel="icon" type="image/jpeg" href="logo.jpeg">
    <style>
        :root { --bg: #05070a; --accent: #007bff; --glass: rgba(255, 255, 255, 0.03); --glass-border: rgba(255, 255, 255, 0.07); --success: #28a745; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: white; margin: 0; background-image: radial-gradient(circle at 50% -20%, #001f3f, var(--bg)); min-height: 100vh; }
        
        nav { background: rgba(5,7,10,0.8); backdrop-filter: blur(20px); border-bottom: 1px solid var(--glass-border); height: 80px; width: 100%; display: flex; justify-content: center; position: sticky; top: 0; z-index: 1000; }
        .nav-container { display: flex; width: 100%; max-width: 1200px; align-items: center; justify-content: space-between; padding: 0 20px; }
        
        .page { width: 100%; max-width: 1000px; margin: auto; padding: 40px 20px; }
        .tournament-card { background: var(--glass); border: 1px solid var(--glass-border); border-radius: 24px; padding: 30px; margin-bottom: 30px; backdrop-filter: blur(10px); position: relative; }
        
        .btn { padding: 10px 20px; border-radius: 8px; cursor: pointer; border: none; font-weight: bold; transition: 0.2s; font-size: 0.8em; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-edit { background: #444; color: white; }
        .btn-save { background: var(--success); color: white; display: none; }

        /* Pavouk */
        .bracket { display: flex; gap: 20px; margin-top: 20px; overflow-x: auto; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 12px; }
        .match { background: #111; border: 1px solid #333; border-radius: 8px; padding: 10px; min-width: 200px; margin-bottom: 10px; }
        .team-row { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; }
        
        input, textarea, select { background: rgba(0,0,0,0.3); border: 1px solid #333; color: white; padding: 10px; border-radius: 8px; width: 100%; box-sizing: border-box; font-family: inherit; }
        .score-input { width: 40px !important; text-align: center; color: var(--accent); font-weight: bold; margin-left: 10px; }
        .edit-mode input, .edit-mode textarea { background: rgba(0, 123, 255, 0.1); border-color: var(--accent); }
    </style>
</head>
<body>
    <nav>
        <div class="nav-container">
            <div id="auth-ui">
                <button id="login-btn" class="btn btn-primary">GOOGLE LOGIN</button>
                <div id="user-info" style="display:none; align-items:center; gap:10px;">
                    <a href="profil.html" style="color:white; text-decoration:none; font-size:14px;">Můj Profil</a>
                    <img id="user-img" src="" style="width:35px; border-radius:50%;">
                </div>
            </div>
            <h2 style="color:var(--accent); letter-spacing:3px; margin:0;">LIGHTSMC.EU</h2>
            <button id="logout-btn" style="display:none; background:transparent; border:none; color:#ff4d4d; cursor:pointer;">ODHLÁSIT</button>
        </div>
    </nav>

    <div class="page">
        <div style="text-align:center; margin-bottom:40px;">
            <button id="create-tourney-btn" class="btn btn-primary" style="display:none;">+ VYTVOŘIT NOVÝ TURNAJ</button>
        </div>

        <div id="tournaments-list">
            </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc, deleteDoc, addDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyBwygFWO20kcMtOVuNT9hpfZPWTfGxNz_U", authDomain: "cspro-web.firebaseapp.com", projectId: "cspro-web", storageBucket: "cspro-web.firebasestorage.app", appId: "1:412820092666:web:cf2f3e419fd9b90b35bb43" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app); const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        let user = null;

        onAuthStateChanged(auth, u => {
            user = u;
            if(u) {
                document.getElementById('login-btn').style.display = 'none';
                document.getElementById('user-info').style.display = 'flex';
                document.getElementById('user-img').src = u.photoURL;
                document.getElementById('logout-btn').style.display = 'block';
                document.getElementById('create-tourney-btn').style.display = 'inline-block';
            }
        });

        document.getElementById('login-btn').onclick = () => signInWithPopup(auth, provider);
        document.getElementById('logout-btn').onclick = () => signOut(auth).then(() => location.reload());

        document.getElementById('create-tourney-btn').onclick = async () => {
            const title = prompt("Název turnaje:");
            if(!title) return;
            await addDoc(collection(db, "open_tournaments"), {
                title, desc: "Pravidla...", owner: user.uid, active: true, 
                mode: "compet", bracket: []
            });
        };

        onSnapshot(collection(db, "open_tournaments"), snap => {
            const list = document.getElementById('tournaments-list');
            list.innerHTML = "";
            snap.forEach(d => {
                const t = d.data();
                const isOwner = user && t.owner === user.uid;
                const card = document.createElement('div');
                card.className = "tournament-card";
                card.id = `card_${d.id}`;

                card.innerHTML = `
                    <div id="view_${d.id}">
                        <span style="color:${t.active ? 'var(--success)':'#777'}; font-size:10px; font-weight:bold;">● ${t.active ? 'AKTIVNÍ':'NEAKTIVNÍ'} | ${t.mode.toUpperCase()}</span>
                        <h2 style="margin:5px 0;">${t.title}</h2>
                        <p style="color:#aaa; font-size:14px;">${t.desc}</p>
                    </div>

                    <div id="edit_form_${d.id}" style="display:none;" class="edit-mode">
                        <label style="font-size:10px; color:var(--accent);">NÁZEV</label>
                        <input id="edit_title_${d.id}" value="${t.title}">
                        <label style="font-size:10px; color:var(--accent);">POPIS / PRAVIDLA</label>
                        <textarea id="edit_desc_${d.id}">${t.desc}</textarea>
                        <label style="font-size:10px; color:var(--accent);">REŽIM</label>
                        <select id="edit_mode_${d.id}">
                            <option value="compet" ${t.mode === 'compet'?'selected':''}>Compet (5v5)</option>
                            <option value="wingman" ${t.mode === 'wingman'?'selected':''}>Wingman (2v2)</option>
                        </select>
                        <label style="font-size:10px; color:var(--accent); display:block; margin-top:10px;">
                            <input type="checkbox" id="edit_active_${d.id}" ${t.active?'checked':''} style="width:auto;"> Turnaj je aktivní
                        </label>
                    </div>

                    <div class="bracket" id="bracket_${d.id}">
                        ${renderBracket(d.id, t.bracket, isOwner)}
                    </div>

                    ${isOwner ? `
                        <div style="margin-top:20px; display:flex; gap:10px;">
                            <button class="btn btn-edit" id="btn_edit_${d.id}" onclick="window.toggleEdit('${d.id}')">UPRAVIT TURNAJ</button>
                            <button class="btn btn-save" id="btn_save_${d.id}" onclick="window.saveTour('${d.id}')">ULOŽIT ZMĚNY</button>
                            <button class="btn" style="background:#ff4d4d; color:white;" onclick="window.delTour('${d.id}')">SMAZAT</button>
                        </div>
                    ` : ''}
                `;
                list.appendChild(card);
            });
        });

        window.toggleEdit = (id) => {
            document.getElementById(`view_${id}`).style.display = 'none';
            document.getElementById(`edit_form_${id}`).style.display = 'block';
            document.getElementById(`btn_edit_${id}`).style.display = 'none';
            document.getElementById(`btn_save_${id}`).style.display = 'block';
            // Zpřístupníme i pavouka
            document.querySelectorAll(`#bracket_${id} input`).forEach(i => i.readOnly = false);
        };

        window.saveTour = async (id) => {
            const title = document.getElementById(`edit_title_${id}`).value;
            const desc = document.getElementById(`edit_desc_${id}`).value;
            const mode = document.getElementById(`edit_mode_${id}`).value;
            const active = document.getElementById(`edit_active_${id}`).checked;
            
            // Uložíme i pavouka (pokud existuje)
            const newBracket = [];
            document.querySelectorAll(`#bracket_${id} .match`).forEach((m, index) => {
                newBracket.push({
                    t1: document.getElementById(`${id}_t1_${index}`).value,
                    s1: document.getElementById(`${id}_s1_${index}`).value,
                    t2: document.getElementById(`${id}_t2_${index}`).value,
                    s2: document.getElementById(`${id}_s2_${index}`).value
                });
            });

            await updateDoc(doc(db, "open_tournaments", id), { title, desc, mode, active, bracket: newBracket });
            alert("Vše uloženo!");
            location.reload();
        };

        function renderBracket(id, bracket, isOwner) {
            if(!bracket || bracket.length === 0) return "<p style='color:#444; font-size:12px;'>Pavouk zatím nebyl vygenerován.</p>";
            return bracket.map((m, i) => `
                <div class="match">
                    <div class="team-row">
                        <input id="${id}_t1_${i}" value="${m.t1}" readonly>
                        <input class="score-input" id="${id}_s1_${i}" value="${m.s1}" type="number" readonly>
                    </div>
                    <div class="team-row">
                        <input id="${id}_t2_${i}" value="${m.t2}" readonly>
                        <input class="score-input" id="${id}_s2_${i}" value="${m.s2}" type="number" readonly>
                    </div>
                </div>
            `).join("");
        }

        window.delTour = async (id) => { if(confirm("Smazat turnaj?")) await deleteDoc(doc(db, "open_tournaments", id)); };
    </script>
</body>
</html>
