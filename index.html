<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <title>LIGHTSMC.EU - Turnaje</title>
    <link rel="icon" type="image/jpeg" href="logo.jpeg">
    <style>
        :root { --bg-color: #0a0a0a; --accent-color: #007bff; --card-bg: #161616; --nav-bg: rgba(10, 10, 10, 0.95); }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-color); color: white; margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; background-image: radial-gradient(circle at 50% -20%, #002b55, #0a0a0a); width: 100%; }
        
        /* Sjednocená navigace */
        nav { background: var(--nav-bg); width: 100%; display: flex; justify-content: center; border-bottom: 1px solid rgba(0, 123, 255, 0.2); position: sticky; top: 0; z-index: 1000; backdrop-filter: blur(15px); width: 100%; }
        .nav-container { display: flex; max-width: 1200px; width: 100%; justify-content: center; align-items: center; position: relative; padding: 0 20px; height: 70px; }
        .nav-link { color: #fff; text-decoration: none; padding: 10px 15px; font-weight: 600; text-transform: uppercase; font-size: 0.75em; transition: 0.3s; opacity: 0.7; letter-spacing: 1px; }
        .nav-link.active { opacity: 1; color: var(--accent-color); }
        .user-controls { position: absolute; left: 20px; display: flex; align-items: center; gap: 10px; }
        .admin-controls { position: absolute; right: 20px; display: flex; }
        #google-login-btn { background: #fff; color: #000; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 0.7em; }

        /* Hero sekce */
        .hero { text-align: center; padding: 100px 20px; max-width: 800px; }
        .hero h1 { font-size: 3.5em; margin-bottom: 10px; letter-spacing: 8px; color: var(--accent-color); }
        .hero p { font-size: 1.2em; color: #ccc; margin-bottom: 30px; }
        
        .reg-card { background: var(--card-bg); padding: 40px; border-radius: 15px; border: 1px solid #222; width: 100%; max-width: 500px; margin-top: 20px; }
        .btn-reg { background: var(--accent-color); color: white; border: none; padding: 18px 30px; border-radius: 8px; font-size: 1.1em; font-weight: bold; cursor: pointer; width: 100%; transition: 0.3s; }
        .btn-reg:disabled { background: #333; cursor: not-allowed; }
        .status-msg { margin-top: 15px; font-size: 0.9em; color: #777; }
    </style>
</head>
<body>
    <nav>
        <div class="nav-container">
            <div class="user-controls">
                <div id="google-login-btn">PŘIHLÁSIT GOOGLE</div>
                <div id="user-area" style="display:none; gap:10px;">
                    <a href="profil.html" class="nav-link">Profil</a>
                    <a href="tym.html" class="nav-link">Tým</a>
                </div>
            </div>
            <a href="index.html" class="nav-link active">Domů</a>
            <a href="playoff.html" class="nav-link">PlayOff</a>
            <a href="kvalifikace.html" class="nav-link">Kvalifikace</a>
            <a href="pravidla.html" class="nav-link">Pravidla</a>
            <a href="archiv.html" class="nav-link">Turnaje</a>
            <div class="admin-controls">
                <a id="logout-btn" class="nav-link" style="display:none; color:#ff4d4d">ODHLÁSIT</a>
            </div>
        </div>
    </nav>

    <div class="hero">
        <img src="logo.jpeg" style="width: 150px; border-radius: 50%; margin-bottom: 20px; border: 2px solid var(--accent-color);">
        <h1 id="tourney-title">LIGHTSMC</h1>
        <p id="tourney-desc">Vítejte na oficiálním turnajovém portálu.</p>
        
        <div id="registration-zone" class="reg-card">
            <h3>REGISTRACE DO TURNAJE</h3>
            <div id="reg-status-content">
                <p>Pro přihlášení do turnaje se musíte nejdříve přihlásit přes Google.</p>
            </div>
            <button id="reg-action-btn" class="btn-reg" disabled>PŘIHLÁSIT TÝM</button>
            <div id="reg-info" class="status-msg"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getFirestore, doc, onSnapshot, getDoc, setDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
        
        const firebaseConfig = { apiKey: "AIzaSyBwygFWO20kcMtOVuNT9hpfZPWTfGxNz_U", authDomain: "cspro-web.firebaseapp.com", projectId: "cspro-web", storageBucket: "cspro-web.firebasestorage.app", appId: "1:412820092666:web:cf2f3e419fd9b90b35bb43" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app); const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        let activeTourneyId = null;
        let userTeamId = null;

        document.getElementById('google-login-btn').onclick = () => signInWithPopup(auth, provider);

        // 1. Načtení aktivního turnaje
        onSnapshot(doc(db, "tournament", "archive_list"), d => {
            if(d.exists()) {
                const data = d.data();
                activeTourneyId = Object.keys(data).find(k => data[k].active === true);
                if(activeTourneyId) {
                    document.getElementById('tourney-title').innerText = data[activeTourneyId].title;
                    document.getElementById('tourney-desc').innerText = data[activeTourneyId].desc;
                    checkRegistrationStatus();
                } else {
                    document.getElementById('tourney-title').innerText = "ŽÁDNÝ TURNAJ";
                    document.getElementById('tourney-desc').innerText = "Momentálně neprobíhá žádný aktivní turnaj.";
                    document.getElementById('registration-zone').style.display = "none";
                }
            }
        });

        // 2. Sledování uživatele
        onAuthStateChanged(auth, async (user) => {
            if(user) {
                document.getElementById('google-login-btn').style.display = 'none';
                document.getElementById('user-area').style.display = 'flex';
                document.getElementById('logout-btn').style.display = 'block';
                
                // Zjistit, jestli má uživatel tým
                const pDoc = await getDoc(doc(db, "players", user.uid));
                if(pDoc.exists() && pDoc.data().teamId) {
                    userTeamId = pDoc.data().teamId;
                }
                checkRegistrationStatus();
            }
        });

        async function checkRegistrationStatus() {
            const btn = document.getElementById('reg-action-btn');
            const info = document.getElementById('reg-info');
            const content = document.getElementById('reg-status-content');

            if(!auth.currentUser) {
                btn.disabled = true;
                return;
            }

            if(!userTeamId) {
                content.innerHTML = "<p>Nejste v žádném týmu. Pro registraci musíte tým založit nebo do nějakého vstoupit.</p>";
                btn.innerText = "ZALOŽIT TÝM";
                btn.disabled = false;
                btn.onclick = () => location.href = "tym.html";
                return;
            }

            // Kontrola, zda je tým už přihlášen v aktivním turnaji
            const tDoc = await getDoc(doc(db, "teams", userTeamId));
            const teamData = tDoc.data();
            
            if(teamData.registeredIn === activeTourneyId) {
                content.innerHTML = `<p>Váš tým <b>${teamData.name}</b> je úspěšně přihlášen!</p>`;
                btn.innerText = "REGISTROVÁNO";
                btn.disabled = true;
                info.innerText = "Nyní vyčkejte na rozlosování v sekci Kvalifikace.";
            } else {
                content.innerHTML = `<p>Jste kapitánem/členem týmu <b>${teamData.name}</b>. Chcete se přihlásit do tohoto turnaje?</p>`;
                btn.innerText = "POTVRDIT PŘIHLÁŠKU";
                btn.disabled = false;
                btn.onclick = async () => {
                    await updateDoc(doc(db, "teams", userTeamId), { registeredIn: activeTourneyId });
                    // Přidání do seznamu pro admina (archiv.html)
                    await updateDoc(doc(db, "tournament", "registrations"), {
                        [userTeamId]: { teamName: teamData.name, leader: auth.currentUser.displayName, date: new Date().toISOString() }
                    }, { merge: true });
                    alert("Tým byl úspěšně přihlášen!");
                    location.reload();
                };
            }
        }

        document.getElementById('logout-btn').onclick = () => signOut(auth).then(() => location.reload());
    </script>
</body>
</html>
