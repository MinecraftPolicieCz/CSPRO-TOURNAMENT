<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

    const firebaseConfig = { apiKey: "AIzaSyBwygFWO20kcMtOVuNT9hpfZPWTfGxNz_U", authDomain: "cspro-web.firebaseapp.com", projectId: "cspro-web", storageBucket: "cspro-web.firebasestorage.app", messagingSenderId: "412820092666", appId: "1:412820092666:web:cf2f3e419fd9b90b35bb43" };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let unsavedChanges = {};

    onAuthStateChanged(auth, user => {
        const logoutBtn = document.getElementById('logout-btn');
        if (user) {
            logoutBtn.style.display = 'block';
            document.querySelectorAll('input, textarea').forEach(el => {
                el.readOnly = false;
                el.addEventListener('input', e => {
                    unsavedChanges[e.target.id] = e.target.value;
                });
            });
        } else {
            logoutBtn.style.display = 'none';
        }
    });

    document.getElementById('logout-btn').addEventListener('click', async () => {
        if (Object.keys(unsavedChanges).length > 0) {
            if (confirm("Chcete ULOŽIT změny v archivu před odhlášením?")) {
                await setDoc(doc(db, "tournament", "archive"), unsavedChanges, { merge: true });
            }
        }
        signOut(auth).then(() => window.location.reload());
    });

    onSnapshot(doc(db, "tournament", "archive"), d => {
        if(d.exists()){
            const data = d.data();
            for(const key in data){
                const el = document.getElementById(key);
                if(el && document.activeElement !== el) el.value = data[key];
            }
        }
    });
</script>
