<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <title>Profil a Tým - CSPRO.CZ</title>
    <style>
        :root { --bg-color: #0f0f0f; --accent-color: #f3a933; --card-bg: #1a1a1a; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-color); color: white; margin: 0; display: flex; flex-direction: column; align-items: center; min-width: 1200px; }
        nav { background: #1a1a1a; width: 100%; display: flex; justify-content: center; border-bottom: 2px solid var(--accent-color); position: sticky; top: 0; z-index: 1000; min-width: 1200px; }
        .nav-link { color: white; text-decoration: none; padding: 20px; font-weight: bold; text-transform: uppercase; font-size: 0.9em; }
        .container { width: 800px; margin-top: 50px; background: var(--card-bg); padding: 40px; border-radius: 15px; border: 1px solid #333; }
        h2 { color: var(--accent-color); text-transform: uppercase; }
        input { background: #000; border: 1px solid #444; color: white; padding: 12px; width: 100%; border-radius: 5px; margin-bottom: 10px; }
        button { background: var(--accent-color); color: black; border: none; padding: 12px 25px; font-weight: bold; border-radius: 5px; cursor: pointer; margin-top: 10px; }
        .danger { background: #ff4d4d; color: white; }
        .member-item { background: #111; padding: 10px; margin: 5px 0; display: flex; justify-content: space-between; align-items: center; border-radius: 5px; }
    </style>
</head>
<body>
    <nav>
        <a href="index.html" class="nav-link">Domů</a>
        <a href="playoff.html" class="nav-link">PlayOff</a>
        <a href="kvalifikace.html" class="nav-link">Kvalifikace</a>
        <a href="pravidla.html" class="nav-link">Pravidla</a>
        <a href="profil.html" class="nav-link" style="color:var(--accent-color)">Profil / Tým</a>
    </nav>

    <div class="container">
        <div id="auth-box">
            <h2>Přihlášení / Registrace</h2>
            <input type="email" id="email" placeholder="E-mail">
            <input type="password" id="pass" placeholder="Heslo">
            <button onclick="login()">PŘIHLÁSIT</button>
            <button onclick="register()" style="background:#444; color:white">REGISTROVAT</button>
        </div>

        <div id="profile-box" style="display:none">
            <div style="border-bottom: 1px solid #333; padding-bottom: 20px; margin-bottom: 20px;">
                <h2>Můj Profil <span id="role-badge" style="font-size:0.5em; color:gray"></span></h2>
                <input type="text" id="nick" placeholder="Herní Nick">
                <input type="text" id="steam" placeholder="Steam Profile URL">
                <button onclick="saveProfile()">ULOŽIT PROFIL</button>
                <button onclick="logout()" class="danger" style="float:right">ODHLÁSIT</button>
            </div>

            <div id="team-section">
                <h2>Můj Tým</h2>
                <div id="no-team">
                    <input type="text" id="t-name" placeholder="Název týmu">
                    <button onclick="createTeam()">VYTVOŘIT TÝM</button>
                </div>
                <div id="has-team" style="display:none">
                    <h3 id="team-display-name"></h3>
                    <div id="member-list"></div>
                    <div id="owner-tools" style="display:none; margin-top: 20px; padding-top: 20px; border-top: 1px dashed #444;">
                        <p style="color:var(--accent-color)">Nástroje majitele:</p>
                        <button class="danger" onclick="deleteTeam()">SMAZAT TÝM</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        const firebaseConfig = { /* TVÁ KONFIGURACE */ };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- AUTH ---
        window.register = async () => {
            const e = document.getElementById('email').value;
            const p = document.getElementById('pass').value;
            try {
                const res = await createUserWithEmailAndPassword(auth, e, p);
                await setDoc(doc(db, "users", res.user.uid), { nick: "", steam: "", role: "hráč", teamId: "" });
                location.reload();
            } catch(e) { alert(e.message); }
        };

        window.login = () => {
            signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('pass').value).catch(e => alert(e.message));
        };

        window.logout = () => signOut(auth).then(() => location.reload());

        // --- LOGIKA ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('auth-box').style.display = 'none';
                document.getElementById('profile-box').style.display = 'block';
                const uDoc = await getDoc(doc(db, "users", user.uid));
                if (uDoc.exists()) {
                    const d = uDoc.data();
                    document.getElementById('nick').value = d.nick;
                    document.getElementById('steam').value = d.steam;
                    document.getElementById('role-badge').innerText = `(${d.role})`;
                    if(d.teamId) showTeam(d.teamId, user.uid, d.role);
                }
            }
        });

        window.saveProfile = async () => {
            await updateDoc(doc(db, "users", auth.currentUser.uid), {
                nick: document.getElementById('nick').value,
                steam: document.getElementById('steam').value
            });
            alert("Uloženo!");
        };

        window.createTeam = async () => {
            const name = document.getElementById('t-name').value;
            if(!name) return;
            const tRef = await addDoc(collection(db, "teams"), {
                name: name,
                ownerID: auth.currentUser.uid,
                members: [auth.currentUser.uid]
            });
            await updateDoc(doc(db, "users", auth.currentUser.uid), { teamId: tRef.id });
            location.reload();
        };

        async function showTeam(tid, uid, role) {
            const tDoc = await getDoc(doc(db, "teams", tid));
            if(tDoc.exists()){
                const t = tDoc.data();
                document.getElementById('no-team').style.display = 'none';
                document.getElementById('has-team').style.display = 'block';
                document.getElementById('team-display-name').innerText = t.name;
                if(t.ownerID === uid || role === 'admin') document.getElementById('owner-tools').style.display = 'block';
                
                // Jednoduchý výpis členů (v reálu bys dělal loop přes ID hráčů)
                document.getElementById('member-list').innerHTML = t.members.map(m => `
                    <div class="member-item">
                        <span>ID: ${m.substring(0,5)}...</span>
                        ${t.ownerID === uid && m !== uid ? `<button onclick="transferOwner('${m}')" style="font-size:10px; padding:5px">Předat vedení</button>` : ''}
                    </div>
                `).join('');
            }
        }
        
        window.transferOwner = async (newOwnerId) => {
           // Zde by byla logika pro update doc(db, "teams", teamId) { ownerID: newOwnerId }
           alert("Předávání majitele vyžaduje TeamID v kontextu. Implementováno na straně DB.");
        }
    </script>
</body>
</html>
        <div id="auth-section">
            <h2>Přihlášení</h2>
            <input type="email" id="email" placeholder="E-mail" style="margin-bottom:10px">
            <input type="password" id="pass" placeholder="Heslo">
            <div style="margin-top:20px">
                <button onclick="handleLogin()">PŘIHLÁSIT SE</button>
                <button class="secondary" onclick="handleRegister()">REGISTROVAT</button>
            </div>
        </div>

        <div id="user-section" style="display:none">
            <div class="section">
                <h2>Můj Profil</h2>
                <div class="form-group">
                    <label>Herní Nick</label>
                    <input type="text" id="p-nick">
                </div>
                <div class="form-group">
                    <label>Steam Profile (URL)</label>
                    <input type="text" id="p-steam">
                </div>
                <div class="form-group">
                    <label>Discord ID</label>
                    <input type="text" id="p-discord">
                </div>
                <button onclick="updateProfile()">ULOŽIT PROFIL</button>
                <button class="danger" onclick="handleLogout()" style="float:right">ODHLÁSIT SE</button>
            </div>

            <div class="section">
                <h2>Můj Tým</h2>
                <div id="no-team">
                    <p>Nejste v žádném týmu.</p>
                    <input type="text" id="new-team-name" placeholder="Název nového týmu">
                    <button onclick="createTeam()">VYTVOŘIT TÝM</button>
                </div>
                <div id="team-info" style="display:none">
                    <h3 id="display-team-name" style="font-size: 2em; margin: 10px 0;"></h3>
                    <p id="owner-badge" style="color:var(--accent-color); font-weight:bold; display:none">JSTE MAJITEL TÝMU</p>
                    
                    <h4>Členové:</h4>
                    <ul id="member-list" class="member-list"></ul>
                    
                    <div id="owner-controls" style="display:none; margin-top:30px; border-top: 1px solid #444; padding-top:20px;">
                        <label>Pozvat hráče (E-mail)</label>
                        <input type="text" id="invite-email" placeholder="E-mail hráče">
                        <button class="secondary" onclick="inviteMember()">POZVAT</button>
                        <hr>
                        <button class="danger" onclick="deleteTeam()">SMAZAT CELÝ TÝM</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, query, where, getDocs, deleteDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyBwygFWO20kcMtOVuNT9hpfZPWTfGxNz_U", authDomain: "cspro-web.firebaseapp.com", projectId: "cspro-web", storageBucket: "cspro-web.firebasestorage.app", messagingSenderId: "412820092666", appId: "1:412820092666:web:cf2f3e419fd9b90b35bb43" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // -- AUTH FUNKCE --
        window.handleRegister = () => {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('pass').value;
            createUserWithEmailAndPassword(auth, email, pass).then(res => {
                setDoc(doc(db, "users", res.user.uid), { nick: "", steam: "", discord: "", teamId: "" });
            }).catch(err => alert(err.message));
        };

        window.handleLogin = () => {
            signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('pass').value)
            .catch(err => alert(err.message));
        };

        window.handleLogout = () => signOut(auth).then(() => location.reload());

        // -- PROFIL A TÝM LOGIKA --
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('auth-section').style.display = 'none';
                document.getElementById('user-section').style.display = 'block';
                loadUserData(user.uid);
            }
        });

        async function loadUserData(uid) {
            const userDoc = await getDoc(doc(db, "users", uid));
            if (userDoc.exists()) {
                const data = userDoc.data();
                document.getElementById('p-nick').value = data.nick || "";
                document.getElementById('p-steam').value = data.steam || "";
                document.getElementById('p-discord').value = data.discord || "";
                if (data.teamId) loadTeamData(data.teamId, uid);
            }
        }

        window.updateProfile = async () => {
            const uid = auth.currentUser.uid;
            await updateDoc(doc(db, "users", uid), {
                nick: document.getElementById('p-nick').value,
                steam: document.getElementById('p-steam').value,
                discord: document.getElementById('p-discord').value
            });
            alert("Profil uložen!");
        };

        window.createTeam = async () => {
            const name = document.getElementById('new-team-name').value;
            if(!name) return;
            const teamRef = doc(collection(db, "teams"));
            const uid = auth.currentUser.uid;
            await setDoc(teamRef, { name: name, ownerID: uid, members: [uid] });
            await updateDoc(doc(db, "users", uid), { teamId: teamRef.id });
            location.reload();
        };

        async function loadTeamData(teamId, currentUid) {
            const teamDoc = await getDoc(doc(db, "teams", teamId));
            if (teamDoc.exists()) {
                const team = teamDoc.data();
                document.getElementById('no-team').style.display = 'none';
                document.getElementById('team-info').style.display = 'block';
                document.getElementById('display-team-name').innerText = team.name;

                if (team.ownerID === currentUid) {
                    document.getElementById('owner-badge').style.display = 'block';
                    document.getElementById('owner-controls').style.display = 'block';
                }
                
                // Zobrazení členů (zde by bylo potřeba víc dotazů pro jména, pro zjednodušení ID)
                const list = document.getElementById('member-list');
                list.innerHTML = team.members.map(m => `<li class="member-item">${m} ${team.ownerID === m ? '(Majitel)' : ''}</li>`).join('');
            }
        }

        window.deleteTeam = async () => {
            if(!confirm("Opravdu smazat tým?")) return;
            // Zde by měla být logika pro promazání teamId u všech členů
            alert("Funkce adminem omezena - kontaktujte majitele webu.");
        };
    </script>
</body>
</html>
