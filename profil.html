<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <title>Profil a Tým - CSPRO.CZ</title>
    <style>
        :root { --bg-color: #0f0f0f; --accent-color: #f3a933; --card-bg: #1a1a1a; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-color); color: white; margin: 0; display: flex; flex-direction: column; align-items: center; min-width: 1200px; }
        nav { background: #1a1a1a; width: 100%; display: flex; justify-content: center; border-bottom: 2px solid var(--accent-color); position: sticky; top: 0; z-index: 1000; min-width: 1200px; }
        .nav-link { color: white; text-decoration: none; padding: 20px; font-weight: bold; text-transform: uppercase; font-size: 0.9em; cursor: pointer; }
        
        .container { width: 800px; margin-top: 50px; background: var(--card-bg); padding: 40px; border-radius: 15px; border: 1px solid #333; }
        .section { margin-bottom: 40px; border-bottom: 1px solid #333; padding-bottom: 20px; }
        h2 { color: var(--accent-color); text-transform: uppercase; letter-spacing: 2px; }
        
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: #aaa; font-size: 0.8em; }
        input { background: #000; border: 1px solid #444; color: white; padding: 12px; width: 100%; border-radius: 5px; box-sizing: border-box; }
        button { background: var(--accent-color); color: black; border: none; padding: 12px 25px; font-weight: bold; border-radius: 5px; cursor: pointer; margin-top: 10px; }
        button.secondary { background: #444; color: white; }
        button.danger { background: #ff4d4d; color: white; }
        
        #auth-section { text-align: center; }
        .member-list { list-style: none; padding: 0; }
        .member-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #222; }
    </style>
</head>
<body>
    <nav>
        <a href="index.html" class="nav-link">Domů</a>
        <a href="playoff.html" class="nav-link">PlayOff</a>
        <a href="kvalifikace.html" class="nav-link">Kvalifikace</a>
        <a href="profil.html" class="nav-link" style="color:var(--accent-color)">Profil / Tým</a>
    </nav>

    <div class="container">
        <div id="auth-section">
            <h2>Přihlášení</h2>
            <input type="email" id="email" placeholder="E-mail" style="margin-bottom:10px">
            <input type="password" id="pass" placeholder="Heslo">
            <div style="margin-top:20px">
                <button onclick="handleLogin()">PŘIHLÁSIT SE</button>
                <button class="secondary" onclick="handleRegister()">REGISTROVAT</button>
            </div>
        </div>

        <div id="user-section" style="display:none">
            <div class="section">
                <h2>Můj Profil</h2>
                <div class="form-group">
                    <label>Herní Nick</label>
                    <input type="text" id="p-nick">
                </div>
                <div class="form-group">
                    <label>Steam Profile (URL)</label>
                    <input type="text" id="p-steam">
                </div>
                <div class="form-group">
                    <label>Discord ID</label>
                    <input type="text" id="p-discord">
                </div>
                <button onclick="updateProfile()">ULOŽIT PROFIL</button>
                <button class="danger" onclick="handleLogout()" style="float:right">ODHLÁSIT SE</button>
            </div>

            <div class="section">
                <h2>Můj Tým</h2>
                <div id="no-team">
                    <p>Nejste v žádném týmu.</p>
                    <input type="text" id="new-team-name" placeholder="Název nového týmu">
                    <button onclick="createTeam()">VYTVOŘIT TÝM</button>
                </div>
                <div id="team-info" style="display:none">
                    <h3 id="display-team-name" style="font-size: 2em; margin: 10px 0;"></h3>
                    <p id="owner-badge" style="color:var(--accent-color); font-weight:bold; display:none">JSTE MAJITEL TÝMU</p>
                    
                    <h4>Členové:</h4>
                    <ul id="member-list" class="member-list"></ul>
                    
                    <div id="owner-controls" style="display:none; margin-top:30px; border-top: 1px solid #444; padding-top:20px;">
                        <label>Pozvat hráče (E-mail)</label>
                        <input type="text" id="invite-email" placeholder="E-mail hráče">
                        <button class="secondary" onclick="inviteMember()">POZVAT</button>
                        <hr>
                        <button class="danger" onclick="deleteTeam()">SMAZAT CELÝ TÝM</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, query, where, getDocs, deleteDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyBwygFWO20kcMtOVuNT9hpfZPWTfGxNz_U", authDomain: "cspro-web.firebaseapp.com", projectId: "cspro-web", storageBucket: "cspro-web.firebasestorage.app", messagingSenderId: "412820092666", appId: "1:412820092666:web:cf2f3e419fd9b90b35bb43" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // -- AUTH FUNKCE --
        window.handleRegister = () => {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('pass').value;
            createUserWithEmailAndPassword(auth, email, pass).then(res => {
                setDoc(doc(db, "users", res.user.uid), { nick: "", steam: "", discord: "", teamId: "" });
            }).catch(err => alert(err.message));
        };

        window.handleLogin = () => {
            signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('pass').value)
            .catch(err => alert(err.message));
        };

        window.handleLogout = () => signOut(auth).then(() => location.reload());

        // -- PROFIL A TÝM LOGIKA --
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('auth-section').style.display = 'none';
                document.getElementById('user-section').style.display = 'block';
                loadUserData(user.uid);
            }
        });

        async function loadUserData(uid) {
            const userDoc = await getDoc(doc(db, "users", uid));
            if (userDoc.exists()) {
                const data = userDoc.data();
                document.getElementById('p-nick').value = data.nick || "";
                document.getElementById('p-steam').value = data.steam || "";
                document.getElementById('p-discord').value = data.discord || "";
                if (data.teamId) loadTeamData(data.teamId, uid);
            }
        }

        window.updateProfile = async () => {
            const uid = auth.currentUser.uid;
            await updateDoc(doc(db, "users", uid), {
                nick: document.getElementById('p-nick').value,
                steam: document.getElementById('p-steam').value,
                discord: document.getElementById('p-discord').value
            });
            alert("Profil uložen!");
        };

        window.createTeam = async () => {
            const name = document.getElementById('new-team-name').value;
            if(!name) return;
            const teamRef = doc(collection(db, "teams"));
            const uid = auth.currentUser.uid;
            await setDoc(teamRef, { name: name, ownerID: uid, members: [uid] });
            await updateDoc(doc(db, "users", uid), { teamId: teamRef.id });
            location.reload();
        };

        async function loadTeamData(teamId, currentUid) {
            const teamDoc = await getDoc(doc(db, "teams", teamId));
            if (teamDoc.exists()) {
                const team = teamDoc.data();
                document.getElementById('no-team').style.display = 'none';
                document.getElementById('team-info').style.display = 'block';
                document.getElementById('display-team-name').innerText = team.name;

                if (team.ownerID === currentUid) {
                    document.getElementById('owner-badge').style.display = 'block';
                    document.getElementById('owner-controls').style.display = 'block';
                }
                
                // Zobrazení členů (zde by bylo potřeba víc dotazů pro jména, pro zjednodušení ID)
                const list = document.getElementById('member-list');
                list.innerHTML = team.members.map(m => `<li class="member-item">${m} ${team.ownerID === m ? '(Majitel)' : ''}</li>`).join('');
            }
        }

        window.deleteTeam = async () => {
            if(!confirm("Opravdu smazat tým?")) return;
            // Zde by měla být logika pro promazání teamId u všech členů
            alert("Funkce adminem omezena - kontaktujte majitele webu.");
        };
    </script>
</body>
</html>
