<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

    const firebaseConfig = { apiKey: "AIzaSyBwygFWO20kcMtOVuNT9hpfZPWTfGxNz_U", authDomain: "cspro-web.firebaseapp.com", projectId: "cspro-web", storageBucket: "cspro-web.firebasestorage.app", messagingSenderId: "412820092666", appId: "1:412820092666:web:cf2f3e419fd9b90b35bb43" };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let unsavedChanges = {}; 

    // Dynamické generování gridu (pokud ho už nemáš v HTML)
    const grid = document.getElementById('main-grid');
    if (grid) {
        for (let i = 1; i <= 8; i++) {
            grid.innerHTML += `<div class="slot"><div style="color:#f3a933; font-weight:bold;">SLOT #${i}</div><div class="match"><div class="row"><input id="s${i}_a1" placeholder="Tým 1"><input id="s${i}_as1" type="number" value="0"></div><div class="row"><input id="s${i}_a2" placeholder="Tým 2"><input id="s${i}_as2" type="number" value="0"></div></div><div class="match"><div class="row"><input id="s${i}_b1" placeholder="Tým 3"><input id="s${i}_bs1" type="number" value="0"></div><div class="row"><input id="s${i}_b2" placeholder="Tým 4"><input id="s${i}_bs2" type="number" value="0"></div></div><div class="match" style="border-color:#4caf50"><div class="row"><input id="s${i}_f1" placeholder="Vítěz A"><input id="s${i}_fs1" type="number" value="0"></div><div class="row"><input id="s${i}_f2" placeholder="Vítěz B"><input id="s${i}_fs2" type="number" value="0"></div></div><div class="win"><input id="s${i}_w" placeholder="POSTUPUJÍCÍ"></div></div>`;
        }
    }

    onAuthStateChanged(auth, user => {
        const logoutBtn = document.getElementById('logout-btn');
        if (user) {
            logoutBtn.style.display = 'block';
            document.querySelectorAll('input').forEach(el => {
                el.readOnly = false;
                el.addEventListener('input', e => {
                    unsavedChanges[e.target.id] = e.target.value;
                    el.style.backgroundColor = "rgba(243, 169, 51, 0.1)"; // Indikace změny
                });
            });
        } else {
            logoutBtn.style.display = 'none';
            document.querySelectorAll('input').forEach(el => el.readOnly = true);
        }
    });

    document.getElementById('logout-btn').addEventListener('click', async () => {
        if (Object.keys(unsavedChanges).length > 0) {
            if (confirm("Chcete ULOŽIT změny v kvalifikaci před odhlášením?")) {
                await setDoc(doc(db, "tournament", "qual"), unsavedChanges, { merge: true });
            }
        }
        signOut(auth).then(() => window.location.reload());
    });

    onSnapshot(doc(db, "tournament", "qual"), d => {
        if(d.exists()){
            const data = d.data();
            for(const key in data){
                const el = document.getElementById(key);
                if(el && document.activeElement !== el) {
                    el.value = data[key];
                    el.style.backgroundColor = "transparent";
                }
            }
        }
    });
</script>
